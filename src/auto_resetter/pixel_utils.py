import time
from dataclasses import dataclass
from typing import Tuple

import mss
import numpy as np
import pyautogui


@dataclass(frozen=True)
class PixelColorService:
    tolerance: int = 5
    
    def get_pixel_color(self, x: int, y: int) -> Tuple[int, int, int]:
        with mss.mss() as sct:
            monitor = {"top": y, "left": x, "width": 1, "height": 1}
            img = np.array(sct.grab(monitor))
            return (int(img[0, 0, 2]), int(img[0, 0, 1]), int(img[0, 0, 0]))

    def get_pixel_color_at_mouse(self) -> Tuple[int, int, int, int, int]:
        x, y = pyautogui.position()
        r, g, b = self.get_pixel_color(x, y)
        return x, y, r, g, b

    def wait_for_pixel_color(
        self,
        x: int,
        y: int,
        target_color: Tuple[int, int, int],
        timeout: float = 10.0,
        check_interval: float = 0.1,
    ) -> bool:
        start_time = time.time()
        target_r, target_g, target_b = target_color
        within_tolerance = lambda current, target: abs(current - target) <= self.tolerance
        matches = lambda r, g, b: all([within_tolerance(r, target_r), within_tolerance(g, target_g), within_tolerance(b, target_b)])

        while time.time() - start_time < timeout:
            if matches(*self.get_pixel_color(x, y)):
                return True
            time.sleep(check_interval)

        return False


